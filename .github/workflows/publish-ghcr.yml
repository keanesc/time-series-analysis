name: Publish Docker image to GHCR

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU (multi-platform)
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          platforms: linux/amd64
          tags: ghcr.io/${{ github.repository }}:latest

      - name: Smoke test published image
        env:
          IMAGE: ghcr.io/${{ github.repository }}:latest
        run: |
          docker pull "$IMAGE"
          docker run -d --rm --name tsa_test -p 8000:8000 "$IMAGE"

          for i in {1..30}; do
            if curl -sSf http://127.0.0.1:8000/health; then break; fi
            sleep 1
          done

          # health endpoint
          curl -sSf http://127.0.0.1:8000/health

          # inference smoke-test: ensure required keys are present
          curl -sSf -X POST http://127.0.0.1:8000/predict \
            -H "Content-Type: application/json" \
            -d '{"hr":80,"spo2":97,"sbp":120,"dbp":70,"motion":0.0}' \
            | python -c "import sys,json; r=json.load(sys.stdin); assert 'anomaly_flag' in r and 'risk_score' in r and 'confidence' in r and 'alert_status' in r"

          docker stop tsa_test || true
